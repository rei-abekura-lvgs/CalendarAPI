<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人診断（四柱推命） - 暦データAPI</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">
                <i class="fas fa-calendar-alt me-2"></i>暦データAPI
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="api_index.html">API仕様</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="api_index.html">API全ファイル一覧</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="search.html">暦データ検索</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="fortune.html">総合運勢</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="personal.html">個人診断（四柱推命）</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container-fluid py-5 mt-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Header -->
                <div class="text-center mb-5">
                    <h1 class="display-4 fw-bold text-primary mb-3">
                        <i class="fas fa-yin-yang me-3"></i>個人診断（四柱推命）
                    </h1>
                    <p class="lead text-muted">
                        生年月日から算出した四柱推命による詳細な運勢診断
                    </p>
                </div>

                <!-- Input Form -->
                <div class="card personal-fortune-card mb-5">
                    <div class="card-header text-white text-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px 20px 0 0;">
                        <h5 class="mb-0">
                            <i class="fas fa-user-edit me-2"></i>生年月日・性別入力
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <!-- 生年月日入力セクション -->
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">
                                <i class="fas fa-calendar me-2 text-primary"></i>生年月日
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label small text-muted">年</label>
                                    <select class="form-select form-select-lg" id="birthYear" style="border-radius: 12px;">
                                        <option value="">年を選択</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small text-muted">月</label>
                                    <select class="form-select form-select-lg" id="birthMonth" style="border-radius: 12px;">
                                        <option value="">月を選択</option>
                                        <option value="1">1月 (睦月)</option>
                                        <option value="2">2月 (如月)</option>
                                        <option value="3">3月 (弥生)</option>
                                        <option value="4">4月 (卯月)</option>
                                        <option value="5">5月 (皐月)</option>
                                        <option value="6">6月 (水無月)</option>
                                        <option value="7">7月 (文月)</option>
                                        <option value="8">8月 (葉月)</option>
                                        <option value="9">9月 (長月)</option>
                                        <option value="10">10月 (神無月)</option>
                                        <option value="11">11月 (霜月)</option>
                                        <option value="12">12月 (師走)</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small text-muted">日</label>
                                    <select class="form-select form-select-lg" id="birthDay" style="border-radius: 12px;">
                                        <option value="">日を選択</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 生時入力セクション -->
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">
                                <i class="fas fa-clock me-2 text-success"></i>生まれた時間
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label small text-muted">時</label>
                                    <select class="form-select form-select-lg" id="birthHour" style="border-radius: 12px;">
                                        <option value="">時を選択</option>
                                        <option value="unknown" class="text-muted">時間不明</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small text-muted">分</label>
                                    <select class="form-select form-select-lg" id="birthMinute" style="border-radius: 12px;">
                                        <option value="0">00分</option>
                                        <option value="15">15分</option>
                                        <option value="30">30分</option>
                                        <option value="45">45分</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 性別入力セクション -->
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">
                                <i class="fas fa-venus-mars me-2 text-warning"></i>性別
                            </h6>
                            <div class="d-flex gap-4">
                                <div class="form-check form-check-lg">
                                    <input class="form-check-input" type="radio" name="gender" id="genderFemale" value="female" checked>
                                    <label class="form-check-label fw-bold" for="genderFemale">
                                        <i class="fas fa-venus me-1 text-danger"></i>女性
                                    </label>
                                </div>
                                <div class="form-check form-check-lg">
                                    <input class="form-check-input" type="radio" name="gender" id="genderMale" value="male">
                                    <label class="form-check-label fw-bold" for="genderMale">
                                        <i class="fas fa-mars me-1 text-primary"></i>男性
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 診断ボタン -->
                        <div class="text-center mb-4">
                            <button type="button" id="fortuneAnalysisBtn" class="btn btn-lg px-5 py-3" 
                                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 25px; color: white; font-weight: bold; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                                <i class="fas fa-magic me-2"></i>詳細運勢診断を開始
                            </button>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-shield-alt me-1"></i>
                                    入力情報は暗号化されて安全に処理されます
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 診断結果表示エリア -->
                <div id="personalFortuneResult"></div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-auto">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="fw-bold mb-1">
                        <i class="fas fa-calendar-alt me-2"></i>暦データAPI
                    </h5>
                    <p class="text-muted mb-0">日本の暦データをJSON形式で提供する無料APIサービス</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="d-flex justify-content-md-end justify-content-start align-items-center gap-3 mb-2">
                        <a href="https://forms.gle/b5J96GXJ8bXxXRxe7" class="text-light" target="_blank" title="お問い合わせフォーム">
                            <i class="fas fa-envelope fa-lg"></i>
                        </a>
                        <a href="https://github.com/rei-abekura-lvgs/CalendarAPI" class="text-light" target="_blank" title="GitHub Repository">
                            <i class="fab fa-github fa-lg"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="js/detailed-fortune.js"></script>
    <script src="js/personal-fortune.js"></script>
    <script src="js/fortune-api.js"></script>
    <script src="js/app.js"></script>

    <script>
        // ページ初期化
        document.addEventListener('DOMContentLoaded', function() {
            // 年選択肢の初期化
            initializeYearOptions();
            
            // 時間選択肢の初期化
            initializeHourOptions();
            
            // 日付更新イベントの設定
            setupDateUpdaters();
            
            // 診断ボタンのイベントリスナー設定
            setupFortuneButton();
            
            // 保存データを復元
            restoreSavedData();
        });

        // 年選択肢の初期化
        function initializeYearOptions() {
            const yearSelect = document.getElementById('birthYear');
            if (yearSelect && yearSelect.children.length <= 1) {
                for (let year = 2010; year >= 1940; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = `${year}年`;
                    yearSelect.appendChild(option);
                }
            }
        }

        // 時間選択肢の初期化
        function initializeHourOptions() {
            const hourSelect = document.getElementById('birthHour');
            if (hourSelect && hourSelect.children.length <= 2) {
                for (let hour = 0; hour <= 23; hour++) {
                    const option = document.createElement('option');
                    option.value = hour;
                    option.textContent = `${hour}時`;
                    hourSelect.appendChild(option);
                }
            }
        }

        // 日付更新機能の設定
        function setupDateUpdaters() {
            const yearSelect = document.getElementById('birthYear');
            const monthSelect = document.getElementById('birthMonth');
            
            if (yearSelect && monthSelect) {
                yearSelect.addEventListener('change', updateDayOptions);
                monthSelect.addEventListener('change', updateDayOptions);
            }
        }

        // 日選択肢の更新
        function updateDayOptions() {
            const yearSelect = document.getElementById('birthYear');
            const monthSelect = document.getElementById('birthMonth');
            const daySelect = document.getElementById('birthDay');
            
            if (!yearSelect || !monthSelect || !daySelect) return;
            
            const year = parseInt(yearSelect.value);
            const month = parseInt(monthSelect.value);
            
            if (!year || !month) return;
            
            const daysInMonth = new Date(year, month, 0).getDate();
            daySelect.innerHTML = '<option value="">日を選択</option>';
            
            for (let day = 1; day <= daysInMonth; day++) {
                const option = document.createElement('option');
                option.value = day;
                option.textContent = `${day}日`;
                daySelect.appendChild(option);
            }
        }

        // 診断ボタンの設定
        function setupFortuneButton() {
            const fortuneBtn = document.getElementById('fortuneAnalysisBtn');
            if (fortuneBtn) {
                fortuneBtn.addEventListener('click', performFortuneDiagnosis);
            }
        }

        // 診断実行
        async function performFortuneDiagnosis() {
            const resultContainer = document.getElementById('personalFortuneResult');
            if (!resultContainer) {
                console.error('結果表示エリアが見つかりません');
                return;
            }
            
            // 入力データ取得
            const yearElement = document.getElementById('birthYear');
            const monthElement = document.getElementById('birthMonth');
            const dayElement = document.getElementById('birthDay');
            const hourElement = document.getElementById('birthHour');
            const genderElement = document.querySelector('input[name="gender"]:checked');
            
            if (!yearElement || !monthElement || !dayElement || !hourElement) {
                showError(resultContainer, '入力フォームの読み込みに問題があります');
                return;
            }
            
            const year = yearElement.value;
            const month = monthElement.value;
            const day = dayElement.value;
            const hour = hourElement.value;
            const gender = genderElement?.value;
            
            // 入力検証
            if (!year || !month || !day || !gender) {
                showError(resultContainer, 'すべての必須項目を入力してください');
                return;
            }

            // ローディング表示
            showLoading(resultContainer, '四柱推命で詳細分析中...');

            try {
                // DetailedFortuneAPIのインスタンス作成と計算
                if (typeof DetailedFortuneAPI !== 'undefined') {
                    const detailedFortuneAPI = new DetailedFortuneAPI();
                    const result = await detailedFortuneAPI.calculateDetailedFortune();
                    
                    if (result) {
                        displayDetailedFortuneResult(result, resultContainer);
                        
                        // 入力データを保存
                        const birthData = { year, month, day, hour, gender };
                        localStorage.setItem('userBirthData', JSON.stringify(birthData));
                    } else {
                        showError(resultContainer, '診断の計算に失敗しました');
                    }
                } else {
                    showError(resultContainer, '診断システムの読み込みに失敗しました');
                }
            } catch (error) {
                console.error('診断エラー:', error);
                showError(resultContainer, '診断処理中にエラーが発生しました');
            }
        }

        // 保存データ復元
        function restoreSavedData() {
            const savedData = localStorage.getItem('userBirthData');
            if (savedData) {
                try {
                    const birthData = JSON.parse(savedData);
                    if (birthData.year) document.getElementById('birthYear').value = birthData.year;
                    if (birthData.month) document.getElementById('birthMonth').value = birthData.month;
                    
                    if (birthData.year && birthData.month) {
                        updateDayOptions();
                        setTimeout(() => {
                            if (birthData.day) document.getElementById('birthDay').value = birthData.day;
                        }, 100);
                    }
                    
                    if (birthData.hour) document.getElementById('birthHour').value = birthData.hour;
                    if (birthData.gender) {
                        document.querySelector(`input[name="gender"][value="${birthData.gender}"]`).checked = true;
                    }
                } catch (e) {
                    console.log('保存データの復元に失敗しました');
                }
            }
        }

        // ローディング表示
        function showLoading(container, message) {
            if (container) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h5 class="text-muted">${message}</h5>
                    </div>
                `;
            }
        }

        // エラー表示
        function showError(container, message) {
            if (container) {
                container.innerHTML = `
                    <div class="alert alert-danger d-flex align-items-center" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${message}
                    </div>
                `;
            }
        }

        // 詳細運勢結果表示
        function displayDetailedFortuneResult(fortune, container) {
            const getScoreClass = (score) => {
                if (score >= 80) return 'score-excellent';
                if (score >= 60) return 'score-good';
                if (score >= 40) return 'score-normal';
                if (score >= 20) return 'score-caution';
                return 'score-warning';
            };

            const html = `
                <div class="row">
                    <div class="col-md-12">
                        <!-- 四柱推命命式表 -->
                        <div class="card mb-4 personal-fortune-card">
                            <div class="card-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px 20px 0 0;">
                                <h6 class="mb-0 text-center">
                                    <i class="fas fa-table me-2"></i>四柱推命命式表
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="fortune-chart mb-4">
                                    <table class="table table-bordered text-center">
                                        <thead>
                                            <tr class="table-dark">
                                                <th>時柱</th>
                                                <th>日柱</th>
                                                <th>月柱</th>
                                                <th>年柱</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="fw-bold text-primary fs-5">${fortune.fourPillars.hour ? fortune.fourPillars.hour.kan : '不明'}</td>
                                                <td class="fw-bold text-warning fs-5">${fortune.fourPillars.day.kan}</td>
                                                <td class="fw-bold text-success fs-5">${fortune.fourPillars.month.kan}</td>
                                                <td class="fw-bold text-info fs-5">${fortune.fourPillars.year.kan}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold text-primary fs-5">${fortune.fourPillars.hour ? fortune.fourPillars.hour.shi : '不明'}</td>
                                                <td class="fw-bold text-warning fs-5">${fortune.fourPillars.day.shi}</td>
                                                <td class="fw-bold text-success fs-5">${fortune.fourPillars.month.shi}</td>
                                                <td class="fw-bold text-info fs-5">${fortune.fourPillars.year.shi}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-leaf me-2 text-success"></i>五行バランス</h6>
                                        <div class="small">
                                            <div>年柱: ${fortune.fourPillars.year.element}（${fortune.fourPillars.year.yinYang}）</div>
                                            <div>月柱: ${fortune.fourPillars.month.element}（${fortune.fourPillars.month.yinYang}）</div>
                                            <div>日柱: ${fortune.fourPillars.day.element}（${fortune.fourPillars.day.yinYang}）</div>
                                            ${fortune.fourPillars.hour ? `<div>時柱: ${fortune.fourPillars.hour.element}（${fortune.fourPillars.hour.yinYang}）</div>` : '<div>時柱: 不明</div>'}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-paw me-2 text-warning"></i>十二支動物</h6>
                                        <div class="small">
                                            <div>年柱: ${fortune.fourPillars.year.animal}</div>
                                            <div>月柱: ${fortune.fourPillars.month.animal}</div>
                                            <div>日柱: ${fortune.fourPillars.day.animal}</div>
                                            ${fortune.fourPillars.hour ? `<div>時柱: ${fortune.fourPillars.hour.animal}</div>` : '<div>時柱: 不明</div>'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 運勢スコア詳細 -->
                        <div class="card mb-4 personal-fortune-card">
                            <div class="card-header text-white" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border-radius: 20px 20px 0 0; color: #333 !important;">
                                <h6 class="mb-0 text-center text-dark">
                                    <i class="fas fa-chart-line me-2"></i>今日の運勢スコア
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-3 mb-3">
                                        <div class="score-circle ${getScoreClass(fortune.scores.love)}">
                                            <div class="score-number">${Math.round(fortune.scores.love)}</div>
                                        </div>
                                        <div class="mt-2"><strong>恋愛運</strong></div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="score-circle ${getScoreClass(fortune.scores.money)}">
                                            <div class="score-number">${Math.round(fortune.scores.money)}</div>
                                        </div>
                                        <div class="mt-2"><strong>金運</strong></div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="score-circle ${getScoreClass(fortune.scores.health)}">
                                            <div class="score-number">${Math.round(fortune.scores.health)}</div>
                                        </div>
                                        <div class="mt-2"><strong>健康運</strong></div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="score-circle ${getScoreClass(fortune.scores.work)}">
                                            <div class="score-number">${Math.round(fortune.scores.work)}</div>
                                        </div>
                                        <div class="mt-2"><strong>仕事運</strong></div>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="score-overall ${getScoreClass(fortune.scores.overall)}">
                                        総合運: ${Math.round(fortune.scores.overall)}点
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 性格分析 -->
                        <div class="card mb-4 personal-fortune-card">
                            <div class="card-header text-white" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border-radius: 20px 20px 0 0; color: #333 !important;">
                                <h6 class="mb-0 text-center text-dark">
                                    <i class="fas fa-user-circle me-2"></i>性格・才能分析
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-3">${fortune.personality}</p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-2"><strong>日干:</strong> ${fortune.fourPillars.day.kan} (${fortune.fourPillars.day.element}・${fortune.fourPillars.day.yinYang})</div>
                                        <div class="mb-2"><strong>今日との相性:</strong> <span class="badge bg-secondary">${fortune.todayCompatibility}%</span></div>
                                    </div>
                                    <div class="col-md-6">
                                        ${fortune.daiun ? `<div class="mb-2"><strong>現在の運気:</strong> ${fortune.daiun.description}</div>` : ''}
                                        ${fortune.ryunen ? `<div class="mb-2"><strong>今年の運気:</strong> ${fortune.ryunen.relationship}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 今日のアドバイス -->
                        <div class="card mb-4 personal-fortune-card">
                            <div class="card-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px 20px 0 0;">
                                <h6 class="mb-0 text-center">
                                    <i class="fas fa-lightbulb me-2"></i>今日のアドバイス
                                </h6>
                            </div>
                            <div class="card-body">
                                <h6><i class="fas fa-star me-2 text-warning"></i>開運行動</h6>
                                <ul class="mb-3">
                                    ${fortune.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                </ul>
                                
                                ${fortune.warnings.length > 0 ? `
                                <h6><i class="fas fa-exclamation-triangle me-2 text-danger"></i>注意事項</h6>
                                <ul class="mb-3">
                                    ${fortune.warnings.map(warn => `<li>${warn}</li>`).join('')}
                                </ul>
                                ` : ''}

                                <h6><i class="fas fa-heart me-2 text-danger"></i>人生アドバイス</h6>
                                <ul>
                                    ${fortune.lifeAdvice.map(advice => `<li>${advice}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }
    </script>
</body>
</html>